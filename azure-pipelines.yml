trigger:
  - main  # Runs pipeline when code is pushed to 'main' branch. 

stages:
# üöÄ START EC2 INSTANCE
- stage: StartEC2
  displayName: "Start EC2 Instance"
  jobs:
  - job: StartJob
    displayName: "Start EC2"
    pool:
      name: "agent3"
    steps:
    - script: |
        chmod +x start_ec2.sh
        ./start_ec2.sh
      displayName: "Executing Start EC2 Script"

# üèó BUILD & PUSH DOCKER IMAGE
- stage: BuildAndPush
  displayName: "Build & Push Docker Image"
  dependsOn: StartEC2
  condition: succeeded()
  jobs:
  - job: BuildDocker
    displayName: "Build & Push Docker Image"
    pool:
      name: "agent3"
    steps:
    - checkout: self
    - script: |
        docker build -t bucky0838/node_project:latest .
        echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        docker push bucky0838/node_project:latest
      displayName: "Build & Push Docker Image"

# üöÄ DEPLOY APPLICATION ON EC2
- stage: DeployApp
  displayName: "Deploy Node.js App"
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: "Deploy App on EC2"
    pool:
      name: "agent3"
    steps:
    - script: |
        ssh -o StrictHostKeyChecking=no -i my-key.pem ubuntu@<EC2_PUBLIC_IP> << 'EOF'
        sudo apt update && sudo apt install -y docker.io
        sudo docker pull bucky0838/node_project:latest
        sudo docker run -d -p 8080:8080 --name my_app bucky0838/node_project:latest
        EOF
      displayName: "Deploy App on EC2"

# üõë STOP EC2 INSTANCE
- stage: StopEC2
  displayName: "Stop EC2 Instance"
  dependsOn: DeployApp
  condition: succeeded()
  jobs:
  - job: StopJob
    displayName: "Stop EC2"
    pool:
      name: "agent3"
    steps:
    - script: |
        chmod +x stop_ec2.sh
        ./stop_ec2.sh
      displayName: "Executing Stop EC2 Script"

# ‚úÖ SUCCESS NOTIFICATION
- stage: SuccessNotification
  displayName: "Notify on Success"
  dependsOn: [StartEC2, BuildAndPush, DeployApp, StopEC2]
  condition: succeeded()
  jobs:
  - job: NotifySuccess
    displayName: "Send Success Notification"
    pool:
      name: "agent3"
    steps:
    - script: echo "Pipeline executed successfully! üéâ"
      displayName: "Notify Success"

# ‚ùå FAILURE NOTIFICATION
- stage: FailureNotification
  displayName: "Notify on Failure"
  dependsOn: [StartEC2, BuildAndPush, DeployApp, StopEC2]
  condition: failed()
  jobs:
  - job: NotifyFailure
    displayName: "Send Failure Notification"
    pool:
      name: "agent3"
    steps:
    - script: echo "Pipeline failed! üö®"
      displayName: "Notify Failure"
